generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Customer {
  id                String             @id @default(uuid())
  name              String
  mobileNumber      String
  createdAt         DateTime           @default(now())
  sltMobileNumber   String?
  nicNumber         String?
  email             String?
  feedbacks         Feedback[]
  tokens            Token[]
  completedServices CompletedService[]
  serviceCases      ServiceCase[]

  @@index([mobileNumber])
}

model Token {
  id                 String             @id @default(uuid())
  tokenNumber        Int
  customerId         String
  serviceTypes       String[]           @default([]) @map("serviceType")
  preferredLanguages Json?
  accountRef         String?
  status             String             @default("waiting")
  isPriority         Boolean            @default(false) // VIP/priority customer flag
  outletId           String
  assignedTo         String?
  counterNumber      Int?
  createdAt          DateTime           @default(now())
  calledAt           DateTime?
  startedAt          DateTime?
  completedAt        DateTime?
  feedback           Feedback?
  completedServices  CompletedService[]
  serviceCases       ServiceCase[]
  officer            Officer?           @relation(fields: [assignedTo], references: [id])
  customer           Customer           @relation(fields: [customerId], references: [id])
  outlet             Outlet             @relation(fields: [outletId], references: [id])

  @@index([outletId, status])
  @@index([assignedTo])
  // Composite index to speed frequent queries filtering outlet + status + date range + ordering by tokenNumber
  @@index([outletId, status, createdAt, tokenNumber])
}

model TeleshopManager {
  id                String             @id @default(uuid())
  name              String
  mobileNumber      String             @unique
  email             String?
  regionId          String
  branchId          String?
  isActive          Boolean            @default(true)
  createdAt         DateTime           @default(now())
  lastLoginAt       DateTime?
  region            Region             @relation(fields: [regionId], references: [id])
  branch            Outlet?            @relation(fields: [branchId], references: [id])
  completedServices CompletedService[]

  @@index([regionId])
  @@index([mobileNumber])
  @@index([branchId])
}

model Officer {
  id                String             @id @default(uuid())
  name              String
  mobileNumber      String             @unique
  outletId          String
  status            String             @default("offline")
  counterNumber     Int?
  isTraining        Boolean            @default(false)
  createdAt         DateTime           @default(now())
  lastLoginAt       DateTime?
  assignedServices  Json?
  languages         Json?
  BreakLog          BreakLog[]
  completedServices CompletedService[]
  serviceCases      ServiceCase[]
  outlet            Outlet             @relation(fields: [outletId], references: [id])
  tokens            Token[]

  @@index([outletId, status])
}

model Outlet {
  id                String             @id @default(uuid())
  name              String
  location          String
  regionId          String
  isActive          Boolean            @default(true)
  createdAt         DateTime           @default(now())
  counterCount      Int?               @default(0)
  kioskPassword     String?            // Password for Walk-in Appoinment dashboard
  officers          Officer[]
  completedServices CompletedService[]
  serviceCases      ServiceCase[]
  region            Region             @relation(fields: [regionId], references: [id])
  tokens            Token[]
  managerQRTokens   ManagerQRToken[]
  appointments      Appointment[]
  teleshopManagers  TeleshopManager[]
  closureNotices    ClosureNotice[]
}

model Region {
  id               String            @id @default(uuid())
  name             String
  managerId        String?
  managerEmail     String?
  managerMobile    String?
  managerPassword  String?
  createdAt        DateTime          @default(now())
  outlets          Outlet[]
  teleshopManagers TeleshopManager[]
}

model Feedback {
  id                String   @id @default(uuid())
  tokenId           String   @unique
  customerId        String
  rating            Int
  comment           String?
  assignedTo        String?  // Based on rating: admin, regional_manager, teleshop_manager
  assignedToId      String?  // ID of the person/role it's assigned to
  isResolved        Boolean  @default(false)
  resolvedAt        DateTime?
  resolvedBy        String?
  resolutionComment String?
  createdAt         DateTime @default(now())
  customer          Customer @relation(fields: [customerId], references: [id])
  token             Token    @relation(fields: [tokenId], references: [id])

  @@index([rating])
  @@index([createdAt])
  @@index([assignedTo, assignedToId])
}

model Document {
  id            String   @id @default(uuid())
  filename      String
  filepath      String
  mimeType      String
  size          Int
  uploadedBy    String
  relatedEntity String
  createdAt     DateTime @default(now())

  @@index([relatedEntity])
}

model Alert {
  id            String   @id @default(uuid())
  type          String
  severity      String
  message       String
  relatedEntity String?
  isRead        Boolean  @default(false)
  createdAt     DateTime @default(now())

  @@index([isRead, createdAt])
}

model Service {
  id               String             @id @default(uuid())
  code             String             @unique
  title            String
  description      String?
  isActive         Boolean            @default(true)
  createdAt        DateTime           @default(now())
  completedServices CompletedService[]
}

model CompletedService {
  id                String          @id @default(uuid())
  tokenId           String
  serviceId         String
  officerId         String
  teleshopManagerId String?
  customerId        String
  outletId          String
  duration          Int?            // Service duration in minutes
  notes             String?
  completedAt       DateTime        @default(now())
  
  // Relations
  token             Token           @relation(fields: [tokenId], references: [id])
  service           Service         @relation(fields: [serviceId], references: [id])
  officer           Officer         @relation(fields: [officerId], references: [id])
  teleshopManager   TeleshopManager? @relation(fields: [teleshopManagerId], references: [id])
  customer          Customer        @relation(fields: [customerId], references: [id])
  outlet            Outlet          @relation(fields: [outletId], references: [id])

  @@index([teleshopManagerId, completedAt])
  @@index([officerId, completedAt])
  @@index([outletId, completedAt])
}

model BreakLog {
  id        String    @id
  officerId String
  startedAt DateTime  @default(now())
  endedAt   DateTime?
  Officer   Officer   @relation(fields: [officerId], references: [id])

  @@index([officerId, startedAt])
}

model ManagerQRToken {
  token       String   @id
  outletId    String
  generatedAt DateTime @default(now())
  createdAt   DateTime @default(now())

  outlet      Outlet   @relation(fields: [outletId], references: [id])

  @@index([outletId])
}

model Appointment {
  id                String   @id @default(uuid())
  name              String
  mobileNumber      String
  outletId          String
  serviceTypes      String[]
  preferredLanguage String?  // 'en' | 'si' | 'ta'
  sltTelephoneNumber String? // For bill payment appointments
  appointmentAt     DateTime
  status            String   @default("booked") // booked | queued | completed | cancelled | no_show
  tokenId           String?
  notes             String?
  createdAt         DateTime @default(now())
  queuedAt          DateTime?
  completedAt       DateTime?

  outlet            Outlet   @relation(fields: [outletId], references: [id])

  @@index([outletId, appointmentAt])
  @@index([mobileNumber, appointmentAt])
  @@index([status, appointmentAt])
}

// Service Tracking: a multi-stage process after the counter service completes
model ServiceCase {
  id            String      @id @default(uuid())
  refNumber     String      @unique
  tokenId       String
  outletId      String
  officerId     String
  teleshopManagerId String?
  customerId    String
  serviceTypes  String[]
  status        String      @default("open") // open | completed | cancelled
  createdAt     DateTime    @default(now())
  completedAt   DateTime?
  lastUpdatedAt DateTime    @default(now())

  // Relations
  token         Token       @relation(fields: [tokenId], references: [id])
  outlet        Outlet      @relation(fields: [outletId], references: [id])
  officer       Officer     @relation(fields: [officerId], references: [id])
  customer      Customer    @relation(fields: [customerId], references: [id])
  updates       ServiceCaseUpdate[]

  @@index([refNumber])
  @@index([outletId, createdAt])
}

model ServiceCaseUpdate {
  id         String      @id @default(uuid())
  caseId     String
  actorRole  String
  actorId    String?
  status     String?
  note       String
  createdAt  DateTime    @default(now())

  serviceCase ServiceCase @relation(fields: [caseId], references: [id])

  @@index([caseId, createdAt])
}

// SLT Bill information for bill payment service
model SltBill {
  id              String   @id @default(uuid())
  telephoneNumber String   @unique // SLT telephone number
  mobileNumber    String?  // Registered mobile number for the SLT account
  accountName     String   // Account holder name
  accountAddress  String?  // Billing address
  currentBill     Float    // Current bill amount
  dueDate         DateTime // Bill due date
  status          String   @default("unpaid") // unpaid | paid | overdue
  lastPaymentDate DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([telephoneNumber])
  @@index([status, dueDate])
}

// GM: General Manager - island-wide minor admin, oversees all DGMs
model GM {
  id           String   @id @default(uuid())
  name         String
  mobileNumber String   @unique
  email        String?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  lastLoginAt  DateTime?
  dgms         DGM[]

  @@index([mobileNumber])
}

// DGM: Deputy General Manager - oversees specific Regions under a GM
model DGM {
  id           String   @id @default(uuid())
  name         String
  mobileNumber String   @unique
  email        String?
  gmId         String
  gm           GM       @relation(fields: [gmId], references: [id])
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  lastLoginAt  DateTime?
  regionIds    String[] // Region IDs this DGM oversees

  @@index([mobileNumber])
  @@index([gmId])
}

// Closure Notices: custom closure messages created by RTOM or Teleshop Manager
model ClosureNotice {
  id          String   @id @default(uuid())
  outletId    String
  title       String
  message     String
  startsAt    DateTime
  endsAt      DateTime
  createdBy   String   // "teleshop_manager" | "rtom_manager"
  createdById String   // ID of the creator
  createdAt   DateTime @default(now())
  outlet      Outlet   @relation(fields: [outletId], references: [id])

  @@index([outletId, endsAt])
}

// Mercantile Holidays: public holidays on which branches are considered closed
model MercantileHoliday {
  id          String   @id @default(uuid())
  date        DateTime // The holiday date (store as date at midnight UTC)
  name        String   // e.g., "Sinhalese & Tamil New Year"
  isRecurring Boolean  @default(false) // true = same month/day every year
  createdAt   DateTime @default(now())

  @@index([date])
}